
name: Dev Pipeline

on:
  push:
    branches: [ "dev" ]

jobs:
  run-databricks-dev:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    environment: dev

    steps:
      - name: Trigger Databricks Job (DEV)
        id: runnow
        env:
          DATABRICKS_HOST: https://dbc-df542d18-8957.cloud.databricks.com
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          JOB_ID: ${{ vars.TRAINING_JOB_ID }}
        run: |
          set -euo pipefail

          # Trigger the job
          resp=$(curl -sS -X POST "$DATABRICKS_HOST/api/2.1/jobs/run-now" \
            -H "Authorization: Bearer $DATABRICKS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"job_id\": $JOB_ID,
              \"notebook_params\": {
                \"git_ref\": \"${{ github.ref_name }}\",
                \"git_sha\": \"${{ github.sha }}\",
                \"n_estimators\": \"150\",
                \"accuracy_threshold\": \"0.87\"
              }
            }")

          echo "Run-now response: $resp"

          # Extract run_id with a Python one-liner (no heredoc)
          run_id=$(echo "$resp" | python3 -c 'import sys,json; print(json.load(sys.stdin).get("run_id",""))')
          if [ -z "$run_id" ]; then
            echo "Failed to obtain run_id from run-now response"
            exit 1
          fi
          echo "run_id=$run_id" >> "$GITHUB_OUTPUT"

          # (Facoltativo) stampa URL cliccabile del run
          echo "Run page: $DATABRICKS_HOST/#job/$JOB_ID/run/$run_id"

      - name: Wait for Databricks job to complete (DEV)
        env:
          DATABRICKS_HOST: https://dbc-df542d18-8957.cloud.databricks.com
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          POLL_INTERVAL_SEC: "15"
          MAX_MINUTES: "120"
        run: |
          set -euo pipefail

          run_id="${{ steps.runnow.outputs.run_id }}"
          echo "Waiting for run_id=$run_id"

          max_seconds=$(( ${MAX_MINUTES} * 60 ))
          poll="${POLL_INTERVAL_SEC}"
          elapsed=0

          while true; do
            resp=$(curl -sS -X GET "$DATABRICKS_HOST/api/2.1/jobs/runs/get?run_id=$run_id" \
              -H "Authorization: Bearer $DATABRICKS_TOKEN")

            # Parse lifecycle & result with Python one-liners
            lifecycle=$(echo "$resp" | python3 -c 'import sys,json; print(json.load(sys.stdin).get("state",{}).get("life_cycle_state",""))')
            result=$(echo "$resp" | python3 -c 'import sys,json; print(json.load(sys.stdin).get("state",{}).get("result_state",""))')

            echo "lifecycle=$lifecycle result=$result elapsed=${elapsed}s"

            # Terminal lifecycle states
            if [ "$lifecycle" = "TERMINATED" ] || [ "$lifecycle" = "INTERNAL_ERROR" ] || [ "$lifecycle" = "SKIPPED" ]; then
              # Fetch output per visibilit√†
              echo "Final run state: $resp"
              
              if [ "$result" = "SUCCESS" ]; then
                echo "Run finished successfully."
                break
              else
                echo "Run finished with non-success result: $result"
                exit 1
              fi
            fi

            if [ $elapsed -ge $max_seconds ]; then
              echo "Timeout after ${MAX_MINUTES} minutes waiting for run $run_id"
              exit 1
            fi

            sleep "$poll"
            elapsed=$(( elapsed + poll ))
          done
